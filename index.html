<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Vibe DApp</title>
  <script src="https://cdn.jsdelivr.net/npm/web3@1.10.0/dist/web3.min.js"></script>
</head>
<body>
  <h1>Vibe DApp</h1>

  <button id="connectButton">Connect Wallet</button>
  <button id="disconnectButton" style="display:none;">Disconnect</button>

  <h2>Current Vibe</h2>
  <p id="currentVibe">Loading...</p>

  <h2>Set Vibe</h2>
  <input type="text" id="newVibe" placeholder="Enter your vibe">
  <button id="setVibeButton">Set Vibe</button>

  <h2>Last 10 Vibes</h2>
  <ul id="vibeHistory"></ul>

  <script>
    const contractAddress = "0xF16D12Bb3703C472F8c22c0C2A7EAF072fe1Bc9c";
    const rpcUrl = "https://api-unstable.shardeum.org";

    const abi = [
      {
        "inputs":[{"internalType":"string","name":"_vibe","type":"string"}],
        "name":"setVibe","outputs":[],"stateMutability":"nonpayable","type":"function"
      },
      {
        "inputs":[],"name":"getVibe","outputs":[{"internalType":"string","name":"","type":"string"}],
        "stateMutability":"view","type":"function"
      },
      {
        "anonymous":false,
        "inputs":[{"indexed":false,"internalType":"string","name":"vibe","type":"string"}],
        "name":"VibeSet","type":"event"
      }
    ];

    let web3;
    let contract;
    let accounts = [];

    async function init() {
      web3 = new Web3(rpcUrl);
      contract = new web3.eth.Contract(abi, contractAddress);
      updateCurrentVibe();
      updateVibeHistory();
    }

    async function updateCurrentVibe() {
      try {
        const vibe = await contract.methods.getVibe().call();
        document.getElementById("currentVibe").innerText = vibe || "No vibe yet.";
      } catch (e) {
        document.getElementById("currentVibe").innerText = "Error fetching vibe";
        console.error(e);
      }
    }

    async function updateVibeHistory() {
      try {
        const cycleInfoUrl = "http://34.57.251.44:4000/cycleinfo/1"; // seed archiver
        const cycleRes = await fetch(cycleInfoUrl);
        const cycleData = await cycleRes.json();

        // pick a live archiver
        const archiver = cycleData.activeArchivers?.[0] || "http://34.57.251.44:4000";

        // fetch contract events
        const eventsRes = await fetch(`${archiver}/events?address=${contractAddress}&limit=10`);
        const events = await eventsRes.json();

        const ul = document.getElementById("vibeHistory");
        ul.innerHTML = "";

        if (!events || events.length === 0) {
          ul.innerHTML = "<li>No vibes yet.</li>";
          return;
        }

        events.slice(-10).reverse().forEach(ev => {
          try {
            // decode input of setVibe(string)
            const decoded = web3.eth.abi.decodeParameters(["string"], ev.data);
            const vibeText = decoded[0];
            const li = document.createElement("li");
            li.textContent = vibeText;
            ul.appendChild(li);
          } catch (err) {
            console.warn("Decode error", err, ev);
          }
        });
      } catch (err) {
        document.getElementById("vibeHistory").innerHTML = "<li>Error fetching vibes</li>";
        console.error(err);
      }
    }

    // Wallet connect / disconnect
    document.getElementById("connectButton").onclick = async () => {
      if (window.ethereum) {
        const w3 = new Web3(window.ethereum);
        try {
          accounts = await window.ethereum.request({ method: "eth_requestAccounts" });
          web3 = w3;
          contract = new web3.eth.Contract(abi, contractAddress);
          document.getElementById("connectButton").style.display = "none";
          document.getElementById("disconnectButton").style.display = "inline-block";
        } catch (e) { console.error(e); }
      }
    };

    document.getElementById("disconnectButton").onclick = () => {
      accounts = [];
      web3 = new Web3(rpcUrl);
      contract = new web3.eth.Contract(abi, contractAddress);
      document.getElementById("connectButton").style.display = "inline-block";
      document.getElementById("disconnectButton").style.display = "none";
    };

    // Set vibe
    document.getElementById("setVibeButton").onclick = async () => {
      if (!accounts.length) { alert("Connect wallet first"); return; }
      const vibe = document.getElementById("newVibe").value;
      try {
        await contract.methods.setVibe(vibe).send({ from: accounts[0] });
        updateCurrentVibe();
        updateVibeHistory();
      } catch (e) { console.error(e); }
    };

    init();
  </script>
</body>
</html>
