<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Vibes DApp</title>
    <script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>
    <style>
        body { font-family: Arial; padding: 20px; background: #f4f4f4; }
        #connectButton { padding: 10px 15px; background: #4CAF50; color: white; border: none; cursor: pointer; }
        #connectButton:disabled { background: gray; }
        .vibe-list { margin-top: 20px; padding: 10px; background: white; border-radius: 5px; }
        .vibe-item { border-bottom: 1px solid #ddd; padding: 5px 0; }
    </style>
</head>
<body>
    <h1>ðŸŒŠ Vibes DApp</h1>
    <button id="connectButton">Connect Wallet</button>

    <div style="margin-top:20px;">
        <input id="vibeInput" placeholder="Enter your vibe" style="padding:5px; width: 200px;">
        <button id="sendVibeButton">Send Vibe</button>
    </div>

    <div id="status" style="margin-top:10px; color:blue;"></div>

    <h2>Past Vibes</h2>
    <div class="vibe-list" id="vibesList">Loading vibes...</div>

    <script>
        const contractAddress = "0xF16D12Bb3703C472F8c22c0C2A7EAF072fe1Bc9c";
        const contractABI = [
            { "inputs": [ { "internalType": "string", "name": "_vibe", "type": "string" } ], "name": "setVibe", "outputs": [], "stateMutability": "nonpayable", "type": "function" },
            { "anonymous": false, "inputs": [ { "indexed": true, "internalType": "address", "name": "user", "type": "address" }, { "indexed": false, "internalType": "string", "name": "newVibe", "type": "string" } ], "name": "VibeChanged", "type": "event" },
            { "inputs": [], "name": "getVibe", "outputs": [ { "internalType": "string", "name": "", "type": "string" } ], "stateMutability": "view", "type": "function" },
            { "inputs": [], "name": "vibe", "outputs": [ { "internalType": "string", "name": "", "type": "string" } ], "stateMutability": "view", "type": "function" }
        ];

        let provider, signer, contract;

        document.getElementById("connectButton").onclick = async () => {
            try {
                if (!window.ethereum) {
                    alert("MetaMask not found");
                    return;
                }
                provider = new ethers.providers.Web3Provider(window.ethereum);
                await provider.send("eth_requestAccounts", []);
                signer = provider.getSigner();
                const address = await signer.getAddress();
                document.getElementById("connectButton").innerText = "Connected: " + address.slice(0,6) + "..." + address.slice(-4);
                contract = new ethers.Contract(contractAddress, contractABI, signer);
                loadVibes();
            } catch (err) {
                console.error(err);
                alert("Connection failed");
            }
        };

        async function loadVibes() {
            try {
                document.getElementById("vibesList").innerHTML = "Loading vibes...";
                const contractReadOnly = new ethers.Contract(contractAddress, contractABI, provider);
                const currentBlock = await provider.getBlockNumber();
                const fromBlock = currentBlock - 50000; // last 50k blocks
                const events = await contractReadOnly.queryFilter("VibeChanged", fromBlock, "latest");

                if (events.length === 0) {
                    document.getElementById("vibesList").innerHTML = "No vibes yet.";
                    return;
                }

                let html = "";
                events.reverse().forEach(ev => {
                    html += `<div class="vibe-item"><b>${ev.args.user}</b>: ${ev.args.newVibe}</div>`;
                });
                document.getElementById("vibesList").innerHTML = html;
            } catch (err) {
                console.error(err);
                document.getElementById("vibesList").innerHTML = "Error loading vibes.";
            }
        }

        document.getElementById("sendVibeButton").onclick = async () => {
            if (!contract) {
                alert("Connect wallet first");
                return;
            }
            const vibeText = document.getElementById("vibeInput").value.trim();
            if (!vibeText) return alert("Enter a vibe");
            try {
                document.getElementById("status").innerText = "Sending transaction...";
                const tx = await contract.setVibe(vibeText);
                await tx.wait();
                document.getElementById("status").innerText = "Vibe sent!";
                document.getElementById("vibeInput").value = "";
                loadVibes();
            } catch (err) {
                console.error(err);
                document.getElementById("status").innerText = "Failed to send vibe";
            }
        };
    </script>
</body>
</html>
