<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Vibe DApp – Shardeum Unstablenet</title>
  <script src="https://cdn.jsdelivr.net/npm/web3@1.10.0/dist/web3.min.js"></script>
  <style>
    body { font-family: Arial, sans-serif; background: #111; color: #fff; padding: 20px; }
    button { padding: 10px; margin-top: 10px; cursor: pointer; border-radius: 5px; }
    input { padding: 8px; width: 300px; margin-top: 10px; border-radius: 5px; }
    #status { margin-top: 15px; color: yellow; }
    #vibeHistory { margin-top: 20px; }
    .vibeItem { background: #222; padding: 6px 10px; margin: 4px 0; border-radius: 5px; }
  </style>
</head>
<body>
  <h1>Vibe Controller (Shardeum Unstablenet)</h1>
  <button id="connectButton">Connect Wallet</button>
  <button id="disconnectButton" style="display:none;">Disconnect</button>
  <div id="walletAddress"></div>

  <h3>Current Vibe:</h3>
  <div id="currentVibe">Not loaded</div>

  <h3>Set New Vibe:</h3>
  <input type="text" id="vibeInput" placeholder="Enter new vibe...">
  <button id="setVibeButton">Set Vibe</button>
  <div id="status"></div>

  <h3>Last 10 Vibes:</h3>
  <div id="vibeHistory">Loading...</div>

  <script>
    const contractABI = [ /* same ABI as before */ ];
    const contractAddress = "0xF16D12Bb3703C472F8c22c0C2A7EAF072fe1Bc9c";
    const explorerApiBase = "https://explorer-unstable.shardeum.org/api"; // placeholder

    let web3, contract, userAccount;

    async function connectWallet() {
      if (!window.ethereum) return alert("MetaMask not installed");
      const accounts = await window.ethereum.request({ method: 'eth_requestAccounts' });
      userAccount = accounts[0];
      document.getElementById("walletAddress").innerText = "Connected: " + userAccount;
      document.getElementById("connectButton").style.display = "none";
      document.getElementById("disconnectButton").style.display = "inline-block";

      web3 = new Web3(window.ethereum);
      contract = new web3.eth.Contract(contractABI, contractAddress);

      loadVibe();
      loadVibeHistory();
      subscribeToEvents();
    }

    function disconnectWallet() {
      userAccount = null;
      document.getElementById("walletAddress").innerText = "";
      document.getElementById("connectButton").style.display = "inline-block";
      document.getElementById("disconnectButton").style.display = "none";
      document.getElementById("currentVibe").innerText = "Not loaded";
      document.getElementById("vibeHistory").innerText = "Disconnected";
    }

    async function loadVibe() {
      const vibe = await contract.methods.getVibe().call();
      document.getElementById("currentVibe").innerText = vibe || "No vibe set yet";
    }

    async function loadVibeHistory() {
      document.getElementById("vibeHistory").innerText = "Loading history...";
      try {
        // First: try RPC
        const events = await contract.getPastEvents("VibeChanged", {
          fromBlock: 0, toBlock: "latest"
        });
        if (events.length) {
          renderEvents(events.slice(-10).reverse());
          return;
        }
      } catch (e) {
        console.error("RPC logs failed:", e);
      }

      // Fallback: Explorer API
      try {
        const url = `${explorerApiBase}/events?address=${contractAddress}&event=VibeChanged&limit=10`;
        const resp = await fetch(url);
        const data = await resp.json();
        if (Array.isArray(data) && data.length) {
          renderExplorerEvents(data);
        } else {
          document.getElementById("vibeHistory").innerText = "No vibes yet (via explorer)";
        }
      } catch (err) {
        console.error("Explorer API failed:", err);
        document.getElementById("vibeHistory").innerText = "Error loading history";
      }
    }

    function renderEvents(events) {
      const container = document.getElementById("vibeHistory");
      container.innerHTML = "";
      events.forEach(e => {
        const item = document.createElement("div");
        item.className = "vibeItem";
        item.innerText = `${e.returnValues.user} → "${e.returnValues.newVibe}"`;
        container.appendChild(item);
      });
    }

    function renderExplorerEvents(list) {
      const container = document.getElementById("vibeHistory");
      container.innerHTML = "";
      list.forEach(ev => {
        const item = document.createElement("div");
        item.className = "vibeItem";
        item.innerText = `${ev.user} → "${ev.newVibe}"`;
        container.appendChild(item);
      });
    }

    function subscribeToEvents() {
      contract.events.VibeChanged({ fromBlock: "latest" })
        .on("data", () => loadVibeHistory())
        .on("error", console.error);
    }

    async function setVibe() {
      const newVibe = document.getElementById("vibeInput").value;
      if (!newVibe) return alert("Enter a vibe");
      document.getElementById("status").innerText = "Sending transaction...";
      try {
        await contract.methods.setVibe(newVibe).send({ from: userAccount });
        document.getElementById("status").innerText = "Vibe updated!";
        loadVibe();
        loadVibeHistory();
      } catch (e) {
        console.error(e);
        document.getElementById("status").innerText = "Transaction failed.";
      }
    }

    document.getElementById("connectButton").addEventListener("click", connectWallet);
    document.getElementById("disconnectButton").addEventListener("click", disconnectWallet);
    document.getElementById("setVibeButton").addEventListener("click", setVibe);
    window.addEventListener('load', async () => {
      if (!window.ethereum) return;
      web3 = new Web3(window.ethereum);
      const accounts = await window.ethereum.request({ method: 'eth_accounts' });
      if (!accounts.length) return;
      userAccount = accounts[0];
      document.getElementById("walletAddress").innerText = "Connected: " + userAccount;
      document.getElementById("connectButton").style.display = "none";
      document.getElementById("disconnectButton").style.display = "inline-block";
      contract = new web3.eth.Contract(contractABI, contractAddress);
      loadVibe();
      loadVibeHistory();
      subscribeToEvents();
    });
  </script>
</body>
</html>
