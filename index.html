<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Shardeum Vibes Chat</title>
<style>
    body { font-family: Arial, sans-serif; background: #121212; color: white; margin: 0; padding: 0; }
    .chat-container { width: 400px; margin: 40px auto; background: #1e1e1e; border-radius: 10px; padding: 20px; }
    .messages { height: 300px; overflow-y: scroll; border: 1px solid #333; padding: 10px; margin-bottom: 10px; }
    .message { margin-bottom: 8px; }
    .timestamp { color: gray; font-size: 0.8em; }
    input, button { padding: 10px; border: none; border-radius: 5px; }
    input { width: 70%; }
    button { background: #ff9800; color: white; cursor: pointer; }
</style>
</head>
<body>

<div class="chat-container">
    <h2>Shardeum Vibes Chat</h2>
    <div id="messages" class="messages"></div>
    <input type="text" id="messageInput" placeholder="Type a message">
    <button onclick="sendMessage()">Send</button>
    <br><br>
    <button onclick="connectWallet()">Connect Wallet</button>
</div>

<script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>
<script>
const CONTRACT_ADDRESS = "0xF16D12Bb3703C472F8c22c0C2A7EAF072fe1Bc9c";
const ABI = [
    // Add your actual contract ABI here
    {
        "inputs": [],
        "name": "getLastMessages",
        "outputs": [
            {
                "components": [
                    { "internalType": "address", "name": "sender", "type": "address" },
                    { "internalType": "string", "name": "text", "type": "string" },
                    { "internalType": "uint256", "name": "timestamp", "type": "uint256" }
                ],
                "internalType": "struct Message[]",
                "name": "",
                "type": "tuple[]"
            }
        ],
        "stateMutability": "view",
        "type": "function"
    },
    {
        "inputs": [{ "internalType": "string", "name": "_text", "type": "string" }],
        "name": "sendMessage",
        "outputs": [],
        "stateMutability": "nonpayable",
        "type": "function"
    }
];

let provider;
let signer;
let contract;

// Load messages for all visitors
async function loadMessages() {
    try {
        const readProvider = new ethers.providers.JsonRpcProvider("https://api-unstablenet.shardeum.org");
        const readContract = new ethers.Contract(CONTRACT_ADDRESS, ABI, readProvider);
        const messages = await readContract.getLastMessages();

        const messagesDiv = document.getElementById("messages");
        messagesDiv.innerHTML = "";

        messages.forEach(msg => {
            const date = new Date(msg.timestamp * 1000);
            messagesDiv.innerHTML += `<div class="message"><b>${msg.sender}</b>: ${msg.text} <div class="timestamp">${date.toLocaleString()}</div></div>`;
        });
        messagesDiv.scrollTop = messagesDiv.scrollHeight;
    } catch (err) {
        console.error("Error loading messages:", err);
    }
}

async function connectWallet() {
    if (window.ethereum) {
        try {
            await window.ethereum.request({ method: "eth_requestAccounts" });
            provider = new ethers.providers.Web3Provider(window.ethereum);
            signer = provider.getSigner();
            contract = new ethers.Contract(CONTRACT_ADDRESS, ABI, signer);
            alert("Wallet connected!");
        } catch (err) {
            console.error(err);
        }
    } else {
        alert("Please install MetaMask!");
    }
}

async function sendMessage() {
    if (!signer) {
        alert("Please connect wallet first.");
        return;
    }
    const text = document.getElementById("messageInput").value;
    if (!text) return;

    try {
        const tx = await contract.sendMessage(text);
        await tx.wait();
        document.getElementById("messageInput").value = "";
        loadMessages(); // refresh chat
    } catch (err) {
        console.error("Error sending message:", err);
    }
}

// Auto-load messages every 10 seconds
loadMessages();
setInterval(loadMessages, 10000);
</script>
</body>
</html>
