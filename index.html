<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Vibes DApp</title>
    <script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background: #f4f4f4; }
        #connectWallet { padding: 10px 20px; font-size: 16px; cursor: pointer; }
        input { padding: 8px; margin: 5px 0; width: 300px; }
        button { padding: 8px 15px; margin: 5px 0; cursor: pointer; }
        #vibesList { margin-top: 20px; background: #fff; padding: 10px; border-radius: 8px; }
        .vibeItem { border-bottom: 1px solid #ddd; padding: 8px 0; }
        .vibeItem:last-child { border-bottom: none; }
        .address { font-size: 12px; color: #555; }
    </style>
</head>
<body>

    <h1>Vibes DApp</h1>
    <button id="connectWallet">Connect Wallet</button>
    <br>
    <input type="text" id="vibeInput" placeholder="Enter your vibe" />
    <button id="sendVibe">Send Vibe</button>

    <h2>Latest Vibes</h2>
    <div id="vibesList">Loading vibes...</div>

<script>
    const contractAddress = "YOUR_CONTRACT_ADDRESS";
    const contractABI = [/* your ABI here */];

    let provider, signer, contract;

    async function initProvider() {
        if (!window.ethereum) {
            alert("MetaMask not found!");
            return;
        }
        provider = new ethers.providers.Web3Provider(window.ethereum);
        signer = provider.getSigner();
        contract = new ethers.Contract(contractAddress, contractABI, signer);
    }

    document.getElementById("connectWallet").addEventListener("click", async () => {
        try {
            await window.ethereum.request({ method: 'eth_requestAccounts' });
            await initProvider();
            alert("Wallet connected!");
            loadPastVibes();
        } catch (err) {
            console.error(err);
            alert("Wallet connection failed");
        }
    });

    document.getElementById("sendVibe").addEventListener("click", async () => {
        if (!contract) await initProvider();
        const vibe = document.getElementById("vibeInput").value.trim();
        if (!vibe) {
            alert("Please enter a vibe");
            return;
        }
        try {
            const tx = await contract.setVibe(vibe);
            await tx.wait();
            alert("Vibe sent!");
            document.getElementById("vibeInput").value = "";
            loadPastVibes();
        } catch (err) {
            console.error(err);
            alert("Failed to send vibe");
        }
    });

    async function loadPastVibes() {
        if (!provider) provider = new ethers.providers.Web3Provider(window.ethereum);
        if (!contract) contract = new ethers.Contract(contractAddress, contractABI, provider);

        try {
            const currentBlock = await provider.getBlockNumber();
            const fromBlock = Math.max(0, currentBlock - 500);

            const events = await contract.queryFilter("VibeChanged", fromBlock, currentBlock);

            const latestVibes = events
                .slice(-10) // last 10
                .reverse()  // newest first
                .map(e => ({
                    address: e.args.user,
                    vibe: e.args.newVibe
                }));

            const vibesList = document.getElementById("vibesList");
            if (latestVibes.length === 0) {
                vibesList.innerHTML = "<p>No vibes found in last 500 blocks.</p>";
                return;
            }

            vibesList.innerHTML = latestVibes.map(v =>
                `<div class="vibeItem">
                    <div>${v.vibe}</div>
                    <div class="address">${v.address}</div>
                </div>`
            ).join("");

        } catch (err) {
            console.error("Error loading vibes:", err);
            document.getElementById("vibesList").innerHTML = "<p>Error loading vibes</p>";
        }
    }
</script>
</body>
</html>
