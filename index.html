<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Vibe DApp</title>
  <script src="https://cdn.jsdelivr.net/npm/web3@1.10.0/dist/web3.min.js"></script>
</head>
<body>
  <h1>Vibe DApp</h1>

  <h2>Last 10 Vibes</h2>
  <ul id="vibeHistory"></ul>

  <script>
    const contractAddress = "0xF16D12Bb3703C472F8c22c0C2A7EAF072fe1Bc9c";
    const cycleInfoUrl = "http://34.57.251.44:4000/cycleinfo/1";
    const web3 = new Web3();

    async function fetchVibes() {
      try {
        // 1. get archiver list
        const res = await fetch(cycleInfoUrl);
        const cycleData = await res.json();
        const archiver = cycleData.activeArchivers?.[0];
        if (!archiver) throw new Error("No archivers found");

        // 2. fetch latest txs
        const txRes = await fetch(`${archiver}/transactions?limit=100`);
        const txs = await txRes.json();

        // 3. filter contract txs
        const vibeTxs = txs.filter(tx => 
          tx.to?.toLowerCase() === contractAddress.toLowerCase()
        );

        // 4. decode last 10
        const ul = document.getElementById("vibeHistory");
        ul.innerHTML = "";

        if (vibeTxs.length === 0) {
          ul.innerHTML = "<li>No vibes yet.</li>";
          return;
        }

        vibeTxs.slice(-10).reverse().forEach(tx => {
          try {
            // skip function selector (4 bytes = 8 hex chars after '0x')
            const data = tx.data;
            if (data && data.startsWith("0x")) {
              const decoded = web3.eth.abi.decodeParameters(["string"], "0x" + data.slice(10));
              const li = document.createElement("li");
              li.textContent = decoded[0];
              ul.appendChild(li);
            }
          } catch (err) {
            console.warn("decode fail", err);
          }
        });

      } catch (err) {
        document.getElementById("vibeHistory").innerHTML = "<li>Error fetching vibes</li>";
        console.error(err);
      }
    }

    fetchVibes();
  </script>
</body>
</html>
